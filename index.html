<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サイバーパンクピアノ</title>
  <script src="https://unpkg.com/tone"></script>
  <style>
    body {
      margin: 0;
      background: black;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }
    h1 {
      margin-top: 20px;
      text-shadow: 0 0 20px #0ff;
    }
    .controls {
      margin: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    select, input, button {
      background: black;
      border: 1px solid #0ff;
      color: white;
      padding: 5px;
      box-shadow: 0 0 10px #0ff;
    }
    .piano {
      display: flex;
      gap: 2px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .key {
      width: 50px;
      height: 200px;
      background: linear-gradient(135deg, #0ff, #f0f, #0f0, #ff0, #0ff);
      background-size: 400% 400%;
      animation: rainbow 5s linear infinite;
      border-radius: 5px;
      box-shadow: 0 0 10px #0ff;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
    }
    .key:active {
      box-shadow: 0 0 30px white;
      transform: scale(0.95);
    }
    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    canvas {
      margin-top: 30px;
      background: black;
      box-shadow: 0 0 20px #0ff;
    }
  </style>
</head>
<body>
  <h1>サイバーパンクピアノ</h1>
  <div class="controls">
    <label>波形:
      <select id="oscType">
        <option>sine</option>
        <option>square</option>
        <option>triangle</option>
        <option>sawtooth</option>
        <option>fatsine</option>
        <option>fatsawtooth</option>
      </select>
    </label>
    <label>鍵盤設定（例: 60,72,12）:
      <input id="keyInput" value="60,72,12" />
    </label>
    <label>フィルター:
      <select id="filterType">
        <option value="lowpass">Lowpass</option>
        <option value="highpass">Highpass</option>
      </select>
    </label>
    <label>カットオフ:
      <input id="cutoff" type="range" min="100" max="5000" value="1500" />
    </label>
    <label>強さ（0〜1）:
      <input id="velocity" type="number" min="0" max="1" step="0.01" value="0.8" />
    </label>
    <button onclick="updateKeys()">更新</button>
  </div>

  <div class="piano" id="piano"></div>
  <canvas id="visualizer" width="800" height="200"></canvas>

  <script>
    let synth, reverb, filter, analyser;
    const pianoDiv = document.getElementById("piano");
    const oscTypeEl = document.getElementById("oscType");
    const cutoffEl = document.getElementById("cutoff");
    const filterTypeEl = document.getElementById("filterType");
    const velocityEl = document.getElementById("velocity");
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");
    const fftSize = 1024;

    Tone.start();

    function createSynth() {
      reverb = new Tone.Reverb({ decay: 3, wet: 0.5 }).toDestination();
      filter = new Tone.Filter({
        type: filterTypeEl.value,
        frequency: parseFloat(cutoffEl.value),
      }).connect(reverb);
      const vibrato = new Tone.Vibrato({ frequency: 5, depth: 0.1 }).connect(filter);
      analyser = new Tone.Analyser("waveform", fftSize);
      synth = new Tone.Synth({
        oscillator: { type: oscTypeEl.value },
        envelope: {
          attack: 0.01,
          decay: 0.3,
          sustain: 0.1,
          release: 1
        }
      }).connect(vibrato).connect(analyser);
    }

    function midiToFreq(n) {
      return Tone.Frequency(n, "midi").toFrequency();
    }

    function updateKeys() {
      const values = document.getElementById("keyInput").value.split(",").map(Number);
      const start = values[0] || 60;
      const end = values[1] || 72;
      const step = values[2] || 12;
      createSynth();
      pianoDiv.innerHTML = '';
      for (let i = start; i <= end; i += step) {
        const key = document.createElement("div");
        key.className = "key";
        key.textContent = Tone.Frequency(i, "midi").toNote();
        key.onclick = () => {
          const velocity = Math.min(1, Math.max(0, parseFloat(velocityEl.value) || 0.8));
          synth.triggerAttackRelease(midiToFreq(i), "2n", undefined, velocity);
        };
        pianoDiv.appendChild(key);
      }
    }

    cutoffEl.addEventListener("input", () => {
      if (filter) filter.frequency.value = parseFloat(cutoffEl.value);
    });

    filterTypeEl.addEventListener("change", updateKeys);
    oscTypeEl.addEventListener("change", updateKeys);

    updateKeys();

    function draw() {
      requestAnimationFrame(draw);
      if (!analyser) return;
      const values = analyser.getValue();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.strokeStyle = "#0ff";
      for (let i = 0; i < values.length; i++) {
        const x = (i / values.length) * canvas.width;
        const y = (0.5 + values[i] / 2) * canvas.height;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
    }
    draw();
  </script>
</body>
</html>
